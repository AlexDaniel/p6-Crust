#!/usr/bin/env perl6-m
use v6;

use HTTP::Server::Tiny;
use Getopt::Tiny;

my $opts = {
    host => '127.0.0.1',
    port => 5000,
};

get-options(
    $opts, <
        e=s
        I=s@
        p|port=i
        h|host=s
        accesslog=!
    >
);

my $httpd = HTTP::Server::Tiny.new($opts<host>, $opts<port>);

# eval
my $app = do {
    if $opts<e> {
        EVAL($opts<e>);
    } elsif @*ARGS.elems > 0 {
        EVALFILE(@*ARGS[0])
    } else {
        EVALFILE('app.psgi')
    }
};
if $opts<accesslog> {
    require Crust::Middleware::AccessLog;
    $app = ::('Crust::Middleware::AccessLog').new(app => $app);
}
$httpd.run($app);
